<script>
/**
 * 계정 이더 조회
 */
let getBalanceBtn = document.getElementById("getBalanceBtn");
getBalanceBtn.addEventListener("click", e=>{
  let address;
  address = document.getElementById("wallet-address-1").value

  let outputWei = document.getElementById("get-balance-output-wei");
  let outputEth = document.getElementById("get-balance-output-eth");
  try {
    web3.eth.getBalance(address, function (error, wei) {
      if (!error) {
        let balance = web3.utils.fromWei(wei, 'ether');
        outputWei.innerHTML = wei + " wei"
        outputEth.innerHTML = balance + " eth"
      }
    });
  } catch (err) {
    document.getElementById("output-error").innerHTML = err;
  }
})

/**
 * 컨트랙트 NFT 조회
 */
let searchNFTBtn = document.getElementById("searchNFTBtn");
let removeResultNFTsBtn = document.getElementById("removeResultNFTsBtn")
let contract2;
let contractAddress2 = document.getElementById("contract-address-2");
let tokenId2 = document.getElementById("token-id-2");
let nftResultDiv2 = document.getElementById("nft-result-div-2")
afterInitFunction = function(){
  console.log("call afterInitFunction")
  contractAddress2.value = nft_contract_address;
}
const clearCardDom = function(){
  // nftResultDiv2.innerHTML = ""
  nftResultDiv2.textContent = ""
}
const addCardDOM = async function(nft_metadata){
  // get image from NFTMetadata
  let imageData = await fetch(nft_metadata.image);
  let tempBlob = await imageData.blob();
  let imageUrl = URL.createObjectURL(tempBlob)

  // make card component
  let wrapperDiv = document.createElement("div")
  wrapperDiv.classList.add("col-3")

  // make card div
  let cardDiv = document.createElement("div");
  cardDiv.classList.add("card")

  let cardImage = document.createElement("img");
  cardImage.classList.add("card-img-top", "p-2");
  cardImage.src = imageUrl;

  let cardBody = document.createElement("div");
  cardBody.classList.add("card-body");

  let cardTitle = document.createElement("h5");
  cardTitle.classList.add("card-title");
  cardTitle.innerText = nft_metadata.name

  let cardText = document.createElement("p");
  cardText.classList.add("card-text");
  cardText.innerText = nft_metadata.description

  // combine div
  cardBody.append(cardTitle)
  cardBody.append(cardText)
  cardDiv.append(cardImage)
  cardDiv.append(cardBody)
  wrapperDiv.append(cardDiv)
  nftResultDiv2.append(wrapperDiv)
}
searchNFTBtn.addEventListener("click", async e => {
  if(contract){

    if(!contract2){
      contract2 = new web3.eth.Contract(nft_contract_abi, contractAddress2.value);
    }
    try {
      // get metadata url from blockchain
      let NFTMetadataUrl = await contract2.methods.tokenURI(Number(tokenId2.value)).call();

      // get metadata from NFTMetadataUrl
      let NFTMetadataResponse = await fetch(NFTMetadataUrl);
      let NFTMetadata = await NFTMetadataResponse.json();

      // add card dom
      await addCardDOM(NFTMetadata);
    } catch (error) {
      alert("조회가 불가능합니다.")
      console.error(error)
    }
  } else {
    console.log("Contract 초기화가 되지 않았습니다.")
  }
})
removeResultNFTsBtn.addEventListener("click", e => {
  clearCardDom();
})

/**
 *
 */


let btn3 = document.getElementById("btn3");
let btn4 = document.getElementById("btn4");
let btn5 = document.getElementById("btn5");
btn3.addEventListener("click", e=>{
  console.log("call btn3")
})
btn4.addEventListener("click", e=>{
  console.log("call btn4")
})
btn5.addEventListener("click", e=>{
  console.log("call btn5")
})
</script>
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>Explore NFT</h1>
      <h3><%= contractAddress %></h3>
    </div>
    <div class="col-12">
      <div class="row">
        <div class="col-12">
          <input type="text" id="address"/>
          <div id="output"></div>
        </div>
        <div class="col-12">


          <button type="button" class="btn btn-primary" id="btn3">test3</button>
          <button type="button" class="btn btn-primary" id="btn4">test4</button>
          <button type="button" class="btn btn-primary" id="btn5">test5</button>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion my-2">
    <div class="accordion-item">
      <h2 class="accordion-header" id="feature-head-1">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#feature-collapse-1" aria-expanded="true" aria-controls="feature-collapse-1">
          이더 조회
        </button>
      </h2>
      <div id="feature-collapse-1" class="accordion-collapse collapse show" aria-labelledby="feature-head-1">
        <div class="accordion-body">
          이더 조회 내용
          <div>
            <input type="text" id="wallet-address-1" placeholder="walletAddress"/>
            <button type="button" class="btn btn-primary" id="getBalanceBtn">조회</button>
          </div>
          <div>
            <div id="get-balance-output-wei"></div>
            <div id="get-balance-output-eth"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="feature-head-2">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#feature-collapse-2" aria-expanded="false" aria-controls="feature-collapse-2">
          컨트랙트 NFT 조회
        </button>
      </h2>
      <div id="feature-collapse-2" class="accordion-collapse collapse" aria-labelledby="feature-head-2">
        <div class="accordion-body">
          <div class="row m-3">
            <div class="col-12">
              <label for="basic-url" class="form-label">Contract Address</label>
              <input type="text" id="contract-address-2" class="form-control mb-2" placeholder="Contract Address"/>
              <label for="basic-url" class="form-label">Token ID</label>
              <input type="text" id="token-id-2" class="form-control mb-2" placeholder="Token ID"/>
              <button type="button" class="btn btn-primary" id="searchNFTBtn">조회</button>
              <button type="button" class="btn btn-danger" id="removeResultNFTsBtn">아래 항목 모두삭제</button>
            </div>
          </div>
          <div class="row m-3" id="nft-result-div-2">
          </div>
        </div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="feature-head-3">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#feature-collapse-3" aria-expanded="false" aria-controls="feature-collapse-3">
          아코디언3
        </button>
      </h2>
      <div id="feature-collapse-3" class="accordion-collapse collapse" aria-labelledby="feature-head-3">
        <div class="accordion-body">
          내용3
        </div>
      </div>
    </div>
  </div>
</div>
